(function() {
    var logElement = document.getElementById('log');
    var visibilityStatus = document.getElementById('visibilityStatus');
    var lastExecutionTime = performance.now();
    var interval = 1000; // 1 second
    var ticking = false;
    var timeoutId = null;

    function log(message) {
        var time = new Date().toLocaleTimeString();
        logElement.textContent += `[${time}] ${message}\n`;

        // Auto-scroll if not scrolled up
        if (logElement.scrollHeight - logElement.clientHeight - logElement.scrollTop <= 10) {
            logElement.scrollTop = logElement.scrollHeight;
        }
    }

    function tick() {
        if (!ticking) return;

        var currentTime = performance.now();
        var elapsed = currentTime - lastExecutionTime;
        lastExecutionTime = currentTime;

        log(`Tick executed after ${elapsed.toFixed(2)} ms (Expected: ${interval} ms)`);

        // Schedule the next tick
        timeoutId = setTimeout(tick, interval);
    }

    function startTicking() {
        if (ticking) return;
        ticking = true;
        lastExecutionTime = performance.now();
        tick();
        log('Ticking started.');
        document.getElementById('startBtn').disabled = true;
        document.getElementById('stopBtn').disabled = false;
    }

    function stopTicking() {
        if (!ticking) return;
        ticking = false;
        clearTimeout(timeoutId);
        log('Ticking stopped.');
        document.getElementById('startBtn').disabled = false;
        document.getElementById('stopBtn').disabled = true;
    }

    function clearLog() {
        logElement.textContent = '';
        log('Log cleared.');
    }

    // Event listeners

    // Page Visibility API
    function handleVisibilityChange() {
        if (document.hidden) {
            visibilityStatus.textContent = 'hidden';
            visibilityStatus.className = 'hidden';
            log('Page became hidden.');
        } else {
            visibilityStatus.textContent = 'visible';
            visibilityStatus.className = 'visible';
            log('Page became visible.');
        }
    }

    document.addEventListener('visibilitychange', handleVisibilityChange, false);

    // Freeze and Resume Events (Page Lifecycle API)
    document.addEventListener('freeze', function() {
        log('Page is freezing.');
    });

    document.addEventListener('resume', function() {
        log('Page has resumed.');
    });

    // Pagehide and Pageshow Events
    window.addEventListener('pagehide', function(event) {
        log('Page is being hidden. Persisted: ' + event.persisted);
    });

    window.addEventListener('pageshow', function(event) {
        log('Page is being shown. Persisted: ' + event.persisted);
    });

    // Window Blur and Focus Events
    window.addEventListener('blur', function() {
        log('Window lost focus.');
    });

    window.addEventListener('focus', function() {
        log('Window gained focus.');
    });

    // Network Online and Offline Events
    window.addEventListener('online', function() {
        log('Network connection restored.');
    });

    window.addEventListener('offline', function() {
        log('Network connection lost.');
    });

    // Battery Status API (if supported)
    if (navigator.getBattery) {
        navigator.getBattery().then(function(battery) {
            log(`Battery level: ${battery.level * 100}%`);
            battery.addEventListener('levelchange', function() {
                log(`Battery level changed: ${battery.level * 100}%`);
            });
        });
    } else {
        log('Battery Status API not supported.');
    }

    // requestAnimationFrame Monitoring
    var lastAnimationFrameTime = performance.now();
    function animate() {
        var currentTime = performance.now();
        var elapsed = currentTime - lastAnimationFrameTime;
        lastAnimationFrameTime = currentTime;

        log(`Animation frame after ${elapsed.toFixed(2)} ms`);
        requestAnimationFrame(animate);
    }
    requestAnimationFrame(animate);

    // Event listeners for buttons
    document.getElementById('startBtn').addEventListener('click', startTicking);
    document.getElementById('stopBtn').addEventListener('click', stopTicking);
    document.getElementById('clearBtn').addEventListener('click', clearLog);

    // Initial log
    log('JavaScript engine sleep test initialized. Click "Start" to begin.');
})();
